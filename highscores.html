<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gangespillet – Highscore</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#ffb703;
      color:#2a1b00;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin:0 0 14px 0;
    }

    h1{
      margin:0;
      font-size:34px;
      font-weight:700;
      line-height:1.1;
    }

    .logo{
      height:54px;
      width:auto;
      display:block;
      object-fit:contain;
      filter: drop-shadow(0 6px 16px rgba(60,30,0,.18));
    }

    .grid{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
    }

    .box{
      background:#fff7db;
      border:3px solid rgba(42,27,0,.25);
      border-radius:16px;
      padding:16px;
      flex:1 1 520px;
      min-width:320px;
    }

    .titleRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .box h2{
      margin:0;
      font-size:18px;
      font-weight:700;
      color:#6a4a00;
      letter-spacing:.5px;
      text-transform:uppercase;
    }

    .status{
      font-size:14px;
      font-weight:700;
      color:#6a4a00;
      white-space:nowrap;
      min-height:18px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:26px;
    }

    th, td{
      padding:10px 8px;
      border-bottom:2px solid rgba(42,27,0,.15);
    }

    th{
      text-align:left;
      color:#6a4a00;
      font-size:16px;
      letter-spacing:.5px;
      text-transform:uppercase;
    }

    td.rank{
      width:70px;
      font-weight:700;
      color:#6a4a00;
      text-align:center;
    }

    td.points{
      width:140px;
      font-weight:700;
      white-space:nowrap;
    }

    td.name{
      font-weight:700;
    }

    td.meta{
      width:220px;
      font-size:18px;
      color:#6a4a00;
      white-space:nowrap;
    }

    .bigError{
      margin-top:12px;
      padding:12px;
      background:#fff;
      border:3px solid #d62828;
      border-radius:14px;
      font:16px/1.3 monospace;
      white-space:pre-wrap;
      display:none;
    }

    @media (max-width: 900px){
      table{ font-size:22px; }
      .logo{ height:46px; }
      h1{ font-size:30px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Gangespillet</h1>
      <img class="logo" src="logo.png" alt="Logo" />
    </div>

    <div class="grid">
      <div class="box">
        <div class="titleRow">
          <h2>Top 5 (alle)</h2>
          <div class="status" id="statusGlobal">Laster…</div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:70px;">#</th>
              <th style="width:140px;">Poeng</th>
              <th>Navn</th>
              <th style="width:220px;">Klasse</th>
            </tr>
          </thead>
          <tbody id="rowsGlobal"></tbody>
        </table>
      </div>

      <div class="box">
        <div class="titleRow">
          <h2>Topp 5 klasser</h2>
          <div class="status" id="statusClass">Laster…</div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:70px;">#</th>
              <th>Klasse</th>
              <th style="width:180px;">Poeng</th>
            </tr>
          </thead>
          <tbody id="rowsClass"></tbody>
        </table>
      </div>
    </div>

    <div class="bigError" id="errBox"></div>
  </div>

<script>
(function(){
  var TOP_GLOBAL = 5;
  var TOP_CLASSES = 5;
  var TOP_IN_CLASS = 8; // snitt av topp 8 (unike navn)

  var ALL_CLASSES = ["8A","8B","8C","8D","9A","9B","9C","9D","9E","10A","10B","10C","10D","10E"];

  var statusGlobal = document.getElementById("statusGlobal");
  var rowsGlobal = document.getElementById("rowsGlobal");

  var statusClass = document.getElementById("statusClass");
  var rowsClass = document.getElementById("rowsClass");

  var errBox = document.getElementById("errBox");

  function showError(text){
    errBox.style.display = "block";
    errBox.textContent = String(text || "Ukjent feil");
  }

  function esc(s){
    s = (s === undefined || s === null) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function normalize(e){
    e = e || {};
    var points = Number(e.points);
    if (!isFinite(points)) points = 0;

    var name = (e.name === undefined || e.name === null) ? "Ukjent" : String(e.name);
    var cls = (e.className === undefined || e.className === null) ? "" : String(e.className);

    return { points: points, name: name, className: cls };
  }

  function requestJson(url, ok, fail){
    try{
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState !== 4) return;

        if (xhr.status >= 200 && xhr.status < 300){
          try{
            var data = JSON.parse(xhr.responseText || "null");
            ok(data);
          }catch(e){
            fail("JSON parse-feil: " + e);
          }
        } else {
          fail("HTTP " + xhr.status + ": " + (xhr.responseText || ""));
        }
      };
      xhr.onerror = function(){
        fail("Nettverksfeil (XHR)");
      };
      xhr.send(null);
    }catch(e2){
      fail("XHR-feil: " + e2);
    }
  }

  function renderGlobal(list){
    rowsGlobal.innerHTML = "";

    if (!list || !list.length){
      statusGlobal.innerHTML = "Ingen scorer.";
      return;
    }

    // Fjernet "Viser topp 5"
    statusGlobal.innerHTML = "";

    var html = "";
    for (var i=0; i<list.length && i<TOP_GLOBAL; i++){
      var e = normalize(list[i]);
      html += ""
        + "<tr>"
        +   "<td class='rank'>" + (i+1) + "</td>"
        +   "<td class='points'>" + esc(e.points) + "p</td>"
        +   "<td class='name'>" + esc(e.name) + "</td>"
        +   "<td class='meta'>" + esc(e.className) + "</td>"
        + "</tr>";
    }
    rowsGlobal.innerHTML = html;
  }

  function uniqByNameSorted(list){
    // list expected already sorted desc by points
    var seen = {};
    var out = [];
    for (var i=0;i<list.length;i++){
      var e = normalize(list[i]);
      var key = String(e.name || "").replace(/^\s+|\s+$/g,"").toLowerCase();
      if (!key) continue;
      if (seen[key]) continue;
      seen[key] = true;
      out.push(e);
    }
    return out;
  }

  function sortByPointsDesc(list){
    list.sort(function(a,b){
      var ap = Number(a && a.points) || 0;
      var bp = Number(b && b.points) || 0;
      return bp - ap;
    });
  }

  function avgTopN(uniqueList){
    if (!uniqueList || uniqueList.length < TOP_IN_CLASS) return null;
    var sum = 0;
    for (var i=0;i<TOP_IN_CLASS;i++){
      sum += (Number(uniqueList[i] && uniqueList[i].points) || 0);
    }
    return sum / TOP_IN_CLASS;
  }

  function renderClasses(classStats){
    rowsClass.innerHTML = "";

    if (!classStats || !classStats.length){
      statusClass.innerHTML = "Ingen klasser (min. " + TOP_IN_CLASS + " navn).";
      return;
    }

    // Fjernet "Snitt av topp 8"
    statusClass.innerHTML = "";

    var html = "";
    for (var i=0; i<classStats.length && i<TOP_CLASSES; i++){
      var c = classStats[i];
      var avg = Math.round(c.avg * 10) / 10;
      html += ""
        + "<tr>"
        +   "<td class='rank'>" + (i+1) + "</td>"
        +   "<td class='name'>" + esc(c.className) + "</td>"
        +   "<td class='points'>" + avg.toFixed(1) + "p</td>"
        + "</tr>";
    }
    rowsClass.innerHTML = html;
  }

  function computeTopClasses(done){
    var results = [];
    var idx = 0;

    function next(){
      if (idx >= ALL_CLASSES.length){
        results.sort(function(a,b){ return b.avg - a.avg; });
        done(results.slice(0, TOP_CLASSES));
        return;
      }

      var cls = ALL_CLASSES[idx++];
      var url = "/.netlify/functions/get-top-scores?className=" + encodeURIComponent(cls) + "&limit=80";

      requestJson(url, function(data){
        if (Object.prototype.toString.call(data) !== "[object Array]") data = [];
        sortByPointsDesc(data);

        var unique = uniqByNameSorted(data);
        var avg = avgTopN(unique);
        if (avg !== null){
          results.push({ className: cls, avg: avg });
        }
        next();
      }, function(){
        next();
      });
    }

    next();
  }

  function load(){
    statusGlobal.innerHTML = "Laster…";
    statusClass.innerHTML = "Laster…";

    requestJson("/.netlify/functions/get-top-scores", function(data){
      if (Object.prototype.toString.call(data) !== "[object Array]") data = [];
      renderGlobal(data);

      computeTopClasses(function(classStats){
        renderClasses(classStats);
      });
    }, function(err){
      statusGlobal.innerHTML = "FEIL";
      statusClass.innerHTML = "FEIL";
      showError(err);
    });
  }

  load();
})();
</script>
</body>
</html>
