<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1-minuttsgangen – Highscore</title>
  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:#ffb703;
      color:#2a1b00;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:20px;
    }
    h1{
      margin:0 0 14px 0;
      font-size:34px;
      font-weight:700;
    }
    .box{
      background:#fff7db;
      border:3px solid rgba(42,27,0,.25);
      border-radius:16px;
      padding:16px;
    }
    .status{
      font-size:18px;
      font-weight:700;
      color:#6a4a00;
      margin-bottom:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:26px;
    }
    th, td{
      padding:10px 8px;
      border-bottom:2px solid rgba(42,27,0,.15);
    }
    th{
      text-align:left;
      color:#6a4a00;
      font-size:18px;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    td.rank{
      width:70px;
      font-weight:700;
      color:#6a4a00;
      text-align:center;
    }
    td.points{
      width:140px;
      font-weight:700;
      white-space:nowrap;
    }
    td.name{
      font-weight:700;
    }
    td.meta{
      width:220px;
      font-size:18px;
      color:#6a4a00;
      white-space:nowrap;
    }
    .bigError{
      margin-top:12px;
      padding:12px;
      background:#fff;
      border:3px solid #d62828;
      border-radius:14px;
      font:16px/1.3 monospace;
      white-space:pre-wrap;
      display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>1-minuttsgangen</h1>

    <div class="box">
      <div class="status" id="status">Laster…</div>

      <table>
        <thead>
          <tr>
            <th style="width:70px;">#</th>
            <th style="width:140px;">Poeng</th>
            <th>Navn</th>
            <th style="width:220px;">Klasse</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="bigError" id="errBox"></div>
    </div>
  </div>

<script>
(function(){
  var TOP = 5;

  var statusEl = document.getElementById("status");
  var rowsEl = document.getElementById("rows");
  var errBox = document.getElementById("errBox");

  function showError(text){
    statusEl.innerHTML = "FEIL";
    errBox.style.display = "block";
    errBox.textContent = String(text || "Ukjent feil");
  }

  function esc(s){
    s = (s === undefined || s === null) ? "" : String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function normalize(e){
    e = e || {};
    var points = Number(e.points);
    if (!isFinite(points)) points = 0;

    var name = (e.name === undefined || e.name === null) ? "Ukjent" : String(e.name);
    var cls = (e.className === undefined || e.className === null) ? "" : String(e.className);

    return { points: points, name: name, className: cls };
  }

  function render(list){
    rowsEl.innerHTML = "";

    if (!list || !list.length){
      statusEl.innerHTML = "Ingen scorer lagret ennå.";
      return;
    }

    statusEl.innerHTML = "Topp " + Math.min(TOP, list.length);

    var i, e, html = "";
    for (i = 0; i < list.length && i < TOP; i++){
      e = normalize(list[i]);
      html += ""
        + "<tr>"
        +   "<td class='rank'>" + (i+1) + "</td>"
        +   "<td class='points'>" + esc(e.points) + "p</td>"
        +   "<td class='name'>" + esc(e.name) + "</td>"
        +   "<td class='meta'>" + esc(e.className) + "</td>"
        + "</tr>";
    }
    rowsEl.innerHTML = html;
  }

  function requestJson(url, ok, fail){
    try{
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState !== 4) return;

        if (xhr.status >= 200 && xhr.status < 300){
          try{
            var data = JSON.parse(xhr.responseText || "null");
            ok(data);
          }catch(e){
            fail("JSON parse-feil: " + e);
          }
        } else {
          fail("HTTP " + xhr.status + ": " + (xhr.responseText || ""));
        }
      };
      xhr.onerror = function(){
        fail("Nettverksfeil (XHR)");
      };
      xhr.send(null);
    }catch(e2){
      fail("XHR-feil: " + e2);
    }
  }

  // Single request. No class stats. No fancy JS.
  requestJson("/.netlify/functions/get-top-scores", function(data){
    if (Object.prototype.toString.call(data) !== "[object Array]") data = [];
    render(data);
  }, function(err){
    showError(err);
  });
})();
</script>
</body>
</html>
